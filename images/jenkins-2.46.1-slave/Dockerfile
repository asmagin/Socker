FROM openjdk:windowsservercore

# $ProgressPreference will disable download progress info and speed-up download
SHELL ["powershell", "-NoProfile", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue'; "]

# Note: Install Jenkins slave
WORKDIR c:/jenkins
# jenkins version being bundled in this docker image
ENV JENKINS_VERSION 2.46.1

RUN Invoke-WebRequest "https://repo.jenkins-ci.org/public/org/jenkins-ci/main/jenkins-war/$env:JENKINS_VERSION/jenkins-war-$env:JENKINS_VERSION.war" -OutFile "$env:TEMP/jenkins.zip" -UseBasicParsing; \
    Expand-Archive "$env:TEMP/jenkins.zip" -Destination "$env:TEMP/jenkins"; \
    # Hack: it seems that in jenkins verison 2.46 slave is generated by renaming remoting jar
    Copy-Item "$env:TEMP/jenkins/WEB-INF/lib/remoting-3.7.jar" -Destination "c:/jenkins/slave.jar"; \
    dir "$env:TEMP" | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue

# Note: Add .NET + ASP.NET
RUN Install-WindowsFeature NET-Framework-45-ASPNET ; \
    Install-WindowsFeature Web-Asp-Net45;

# Note: Get MSBuild 14.
RUN Invoke-WebRequest "https://download.microsoft.com/download/E/E/D/EEDF18A8-4AED-4CE0-BEBE-70A83094FC5A/BuildTools_Full.exe" -OutFile "$env:TEMP\BuildTools_Full.exe" -UseBasicParsing; \
    Start-Process -FilePath "$env:TEMP\BuildTools_Full.exe" -ArgumentList '/Passive', '/NoRestart' -PassThru | Wait-Process; \
    dir "$env:TEMP" | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
    # Todo: delete the BuildTools_Full.exe file in this layer

# Note: Add NuGet
WORKDIR c:/nuget
RUN Invoke-WebRequest "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -OutFile "c:/nuget/nuget.exe" -UseBasicParsing;

WORKDIR c:/Program Files (x86)/MSBuild/Microsoft/VisualStudio/v14.0
# Note: Install Web Targets v14
RUN & "c:/nuget/nuget.exe" Install MSBuild.Microsoft.VisualStudio.Web.targets -Version 14.0.0.3 ; \
    mv 'c:/Program Files (x86)/MSBuild/Microsoft/VisualStudio/v14.0/MSBuild.Microsoft.VisualStudio.Web.targets.14.0.0.3/tools/VSToolsPath/*' 'c:/Program Files (x86)/MSBuild/Microsoft/VisualStudio/v14.0/'; \
    setx PATH '%PATH%;c:/Program Files (x86)/MSBuild/14.0/Bin/msbuild.exe';

# Note: Install Git
ENV GIT_VERSION=2.12.2
WORKDIR c:/git
RUN Invoke-WebRequest "https://github.com/git-for-windows/git/releases/download/v$env:GIT_VERSION.windows.1/Git-$env:GIT_VERSION-64-bit.exe" -OutFile "$env:TEMP/git.exe" -UseBasicParsing; \
    Start-Process -FilePath "$env:TEMP/git.exe" -ArgumentList '/VERYSILENT', '/NORESTART', '/NOCANCEL', '/SP-', '/DIR="c:/git"' -PassThru | Wait-Process; \
    dir "$env:TEMP" | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue

# Note: Install NodeJS
ENV NODEJS_VERSION=6.10.1
RUN Invoke-WebRequest "https://nodejs.org/dist/v$env:NODEJS_VERSION/node-v$env:NODEJS_VERSION-x64.msi" -OutFile "$env:TEMP/nodejs.msi" -UseBasicParsing; \
    Start-Process -FilePath "$env:TEMP/nodejs.msi" -ArgumentList '/quiet', '/norestart' -PassThru | Wait-Process; \
    dir "$env:TEMP" | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue

# Note: Install Jetbrains Static Code Analysis tools
ENV JETBRAINS_TOOLS_VERSION=2016.3.20170126.124346
WORKDIR c:/jetbrains-commandline-tools
RUN Invoke-WebRequest "https://download.jetbrains.com/resharper/JetBrains.ReSharper.CommandLineTools.$env:JETBRAINS_TOOLS_VERSION.zip" -OutFile "$env:TEMP/jetbrains.zip" -UseBasicParsing; \
    Expand-Archive "$env:TEMP/jetbrains.zip" -Destination "c:/jetbrains-commandline-tools"; \
    dir "$env:TEMP" | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue

# Note: Install Nunit 
ENV NUNIT_VERSION=3.6.1
WORKDIR c:/nunit
RUN Invoke-WebRequest "https://github.com/nunit/nunit-console/releases/download/$env:NUNIT_VERSION/NUnit.Console-$env:NUNIT_VERSION.zip" -OutFile "$env:TEMP/nunit.zip" -UseBasicParsing; \
    Expand-Archive "$env:TEMP/nunit.zip" -Destination "c:/nunit"; \
    dir "$env:TEMP" | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue

# Note: Install xUnit 
ENV XUNIT_VERSION=2.2.0
WORKDIR c:/xunit
RUN cd $env:TEMP; \
    & "c:/nuget/nuget.exe" Install xunit.runner.console -Version $env:XUNIT_VERSION; \
    mv "$env:TEMP/xunit.runner.console.$env:XUNIT_VERSION/tools/*" 'c:/xunit'; \
    dir "$env:TEMP" | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue; \ 
    cd / ;

WORKDIR c:/

CMD [ "java", "-jar", "c:/jenkins/slave.jar" ]